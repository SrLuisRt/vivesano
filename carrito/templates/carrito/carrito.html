{% extends 'core/base.html' %}
{% load filtros_extra %}

{% block title %}Tu Carrito - Vive Sano{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">游 Tu Carrito de Compras</h2>

    {% if carrito|length > 0 %}
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th class="text-center">Cantidad</th>
                                <th>Total</th>
                                <th>Acci칩n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, item in carrito.carrito.items %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ item.nombre }}</div>
                                </td>
                                <td>{{ item.precio|clp }}</td>
                                
                                <td style="width: 150px;">
                                    <form action="{% url 'carrito:actualizar' item.producto_id %}" method="POST" id="form-{{ item.producto_id }}">
                                        {% csrf_token %}
                                        <input type="number" 
                                               name="cantidad" 
                                               class="form-control text-center mx-auto" 
                                               value="{{ item.cantidad }}" 
                                               min="0" 
                                               style="width: 80px;"
                                               onchange="validarYEnviar(this, '{{ item.producto_id }}', '{{ item.nombre }}')">
                                    </form>
                                </td>

                                <td>
                                    {% widthratio item.precio 1 item.cantidad as subtotal %}
                                    {{ subtotal|clp }}
                                </td>
                                <td>
                                    <a href="#"
                                    onclick="confirmarEliminar('{{ eliminar_url }}', '{{ item.nombre }}')"
                                    class="text-danger fs-5">
                                        <i class="bi bi-trash-fill"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3 text-end">
                <a href="{% url 'carrito:limpiar' %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('쮼st치s seguro de vaciar todo el carrito?');">Vaciar Carrito</a>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Resumen</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total a Pagar:</span>
                        <span class="fs-4 fw-bold text-success">{{ total|clp }}</span>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{% url 'carrito:checkout' %}" class="btn btn-dark btn-lg shadow">
                            Ir a Pagar <i class="bi bi-credit-card-2-front ms-2"></i>
                        </a>
                        <a href="{% url 'catalogo:catalogo' %}" class="btn btn-outline-secondary">Seguir comprando</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 bg-light rounded-3">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h3 class="mt-3 text-muted">Tu carrito est치 vac칤o</h3>
        <a href="{% url 'catalogo:catalogo' %}" class="btn btn-success mt-3">Ir a comprar</a>
    </div>
    {% endif %}
</div>

<script>
    // 1. Validar cambio en el input (Si pone 0 -> Confirmar)
    function validarYEnviar(input, idProducto, nombreProducto) {
        var cantidad = parseInt(input.value);
        var form = document.getElementById('form-' + idProducto);

        if (cantidad === 0) {
            // Si el usuario puso 0, preguntamos si quiere eliminar
            var confirmar = confirm("쮼st치s seguro que deseas eliminar '" + nombreProducto + "' del carrito?");
            if (confirmar) {
                form.submit(); // Enviamos el 0 para que el backend lo borre
            } else {
                input.value = 1; // Si cancela, devolvemos a 1 (o al valor anterior si guardas estado)
            }
        } else if (cantidad < 0) {
            // Evitar negativos
            alert("La cantidad no puede ser negativa.");
            input.value = 1;
        } else {
            // Si es un n칰mero v치lido mayor a 0, actualizamos autom치ticamente
            form.submit();
        }
    }

    // 2. Validar clic en el basurero
    function confirmarEliminar(url, nombreProducto) {
        var confirmar = confirm("쮼st치s seguro que deseas eliminar '" + nombreProducto + "'?");
        if (confirmar) {
            window.location.href = url;
        }
    }
</script>
{% endblock %}